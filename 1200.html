<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIEMENS S7-1200选型网站</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chosen Palette: Cool Gray Neutrals -->
    <!-- Application Structure Plan: 本应用采用一个动态的、分步式的单页仪表板结构来引导用户完成S7-1200的配置过程。这种结构将复杂的选型任务分解为三个逻辑步骤：1) 需求定义, 2) 配置推荐与校验, 3) 物料清单生成。用户在第一步输入所有需求，第二步和第三步的结果会实时动态更新。这种设计使用户可以即时看到其输入变化对最终配置、成本和有效性（如功率和槽位）的影响，从而提供了一个直观、高效且不易出错的交互体验。这比简单地罗列手册内容更能满足用户“通过输入IO点信息生成配置”的核心目标。 -->
    <!-- Visualization & Content Choices: 关键信息通过多种方式呈现：1) 用户需求通过HTML表单元素（数字输入、下拉选择框）进行收集。2) 配置结果使用动态生成的HTML表格清晰地列出推荐的CPU和模块。3) 关键的有效性校验通过可视化图表进行：功率预算使用Chart.js（Canvas）实现的条形图，直观对比CPU供电能力和模块总消耗；扩展槽位则通过HTML/CSS动态着色的div元素模拟，清晰展示已用和可用槽位。所有交互逻辑由原生JavaScript处理，确保了应用的轻量和高效。这种设计将抽象的技术手册数据转化为直观、可操作的可视化界面。 -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
        }
        .step-card {
            transition: all 0.3s ease-in-out;
        }
        .form-input {
            width: 100%;
            padding: 0.5rem;
            border-radius: 0.375rem;
            border: 1px solid #D1D5DB;
        }
        .result-highlight {
            color: #1D4ED8;
        }
        .error-message {
            color: #B91C1C;
            background-color: #FEE2E2;
            border-left: 4px solid #EF4444;
        }
         .success-message {
            color: #065F46;
            background-color: #D1FAE5;
            border-left: 4px solid #10B981;
        }
        .chart-container {
            position: relative;
            width: 100%;
            height: 250px;
            max-width: 500px;
            margin: auto;
        }
        /* Siemens Watermark Styles */
        #siemens-watermark {
            position: fixed;
            top: 15px; /* Adjusted for larger font size */
            right: 20px;
            text-align: right;
            z-index: 1000;
            pointer-events: none; /* Allows clicking through the element */
            user-select: none; /* Prevents text selection */
        }
        #siemens-watermark .brand {
            font-size: 52px; /* Increased to match width of credits below */
            font-weight: 700;
            color: #009999; /* Official Siemens Teal */
        }
        #siemens-watermark .credits {
            font-size: 12px;
            color: #4A5568; /* a dark gray color */
            margin-top: 4px;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <!-- Siemens Watermark -->
    <div id="siemens-watermark">
        <div class="brand">SIEMENS</div>
        <div class="credits">制作：谢礼阳 OEM Sales 13372509117</div>
    </div>

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <header class="text-center mb-10">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900">交互式 S7-1200 配置助手</h1>
            <p class="mt-2 text-lg text-slate-600">配置方案仅供参考，谢礼阳 13372509117。</p>
        </header>

        <main class="space-y-8">
            <!-- Step 1: Requirements Definition -->
            <section id="step1" class="step-card bg-white p-6 rounded-xl shadow-lg border border-slate-200">
                <div class="flex items-center mb-4">
                    <div class="flex-shrink-0 bg-blue-600 text-white rounded-full h-10 w-10 flex items-center justify-center text-xl font-bold">1</div>
                    <h2 class="ml-4 text-2xl font-semibold text-slate-900">定义项目需求</h2>
                </div>
                <p class="text-slate-600 mb-6">请在此输入您项目所需的所有I/O点数和功能。本工具将根据您的输入实时计算最佳配置。所有未填写的项目将默认为0或不需要。</p>
                <div id="config-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div>
                        <h3 class="font-semibold text-lg mb-2 text-slate-700">数字量 I/O</h3>
                        <div class="space-y-3">
                            <div><label class="block text-sm font-medium text-slate-600">数字量输入 (DI) 点数:</label><input type="number" id="di" min="0" value="20" class="form-input"></div>
                            <div><label class="block text-sm font-medium text-slate-600">数字量输出 (DO) 点数:</label><input type="number" id="do" min="0" value="16" class="form-input"></div>
                            <div><label class="block text-sm font-medium text-slate-600">其中继电器型DO点数:</label><input type="number" id="do_relay" min="0" value="4" class="form-input"></div>
                        </div>
                    </div>
                    <div>
                        <h3 class="font-semibold text-lg mb-2 text-slate-700">模拟量 I/O</h3>
                        <div class="space-y-3">
                            <div><label class="block text-sm font-medium text-slate-600">模拟量输入 (AI) 点数:</label><input type="number" id="ai" min="0" value="5" class="form-input"></div>
                            <div><label class="block text-sm font-medium text-slate-600">模拟量输出 (AO) 点数:</label><input type="number" id="ao" min="0" value="2" class="form-input"></div>
                        </div>
                    </div>
                     <div>
                        <h3 class="font-semibold text-lg mb-2 text-slate-700">温度测量</h3>
                        <div class="space-y-3">
                             <div><label class="block text-sm font-medium text-slate-600">热电偶 (TC) 输入点数:</label><input type="number" id="tc" min="0" value="3" class="form-input"></div>
                            <div><label class="block text-sm font-medium text-slate-600">热电阻 (RTD) 输入点数:</label><input type="number" id="rtd" min="0" value="1" class="form-input"></div>
                        </div>
                    </div>
                    <div>
                        <h3 class="font-semibold text-lg mb-2 text-slate-700">高速 I/O</h3>
                        <div class="space-y-3">
                            <div><label class="block text-sm font-medium text-slate-600">高速计数器 (HSC) 通道数:</label><input type="number" id="hsc" min="0" value="2" class="form-input"></div>
                            <div><label class="block text-sm font-medium text-slate-600">脉冲串输出 (PTO) 通道数:</label><input type="number" id="pto" min="0" value="4" class="form-input"></div>
                        </div>
                    </div>
                    <div>
                        <h3 class="font-semibold text-lg mb-2 text-slate-700">通信需求</h3>
                        <div class="space-y-2">
                             <div class="flex items-center"><input type="checkbox" id="comm_rs485" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked><label for="comm_rs485" class="ml-2 block text-sm text-slate-600">需要 RS485/RS232 接口</label></div>
                             <div class="flex items-center"><input type="checkbox" id="comm_profibus" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"><label for="comm_profibus" class="ml-2 block text-sm text-slate-600">需要 PROFIBUS DP 主站</label></div>
                        </div>
                    </div>
                    <div>
                        <h3 class="font-semibold text-lg mb-2 text-slate-700">其他需求</h3>
                        <div class="space-y-2">
                            <div class="flex items-center"><input type="checkbox" id="fail_safe" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"><label for="fail_safe" class="ml-2 block text-sm text-slate-600">需要故障安全 (F-CPU)</label></div>
                            <div>
                                <label for="expansion_reserve" class="block text-sm font-medium text-slate-600">未来扩展预留 (%):</label>
                                <select id="expansion_reserve" class="form-input">
                                    <option value="0">0%</option>
                                    <option value="10">10%</option>
                                    <option value="20" selected>20%</option>
                                    <option value="30">30%</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Step 2: Proposed Configuration & Validation -->
            <section id="step2" class="step-card bg-white p-6 rounded-xl shadow-lg border border-slate-200">
                 <div class="flex items-center mb-4">
                    <div class="flex-shrink-0 bg-blue-600 text-white rounded-full h-10 w-10 flex items-center justify-center text-xl font-bold">2</div>
                    <h2 class="ml-4 text-2xl font-semibold text-slate-900">配置推荐与校验</h2>
                </div>
                <div id="validation-summary" class="mb-6 p-4 rounded-lg"></div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div>
                        <h3 class="font-semibold text-lg mb-3 text-slate-700">推荐硬件</h3>
                        <div class="space-y-4">
                           <div>
                                <h4 class="font-medium text-slate-600">中央处理器 (CPU):</h4>
                                <p id="cpu-result" class="p-2 bg-slate-100 rounded-md">-</p>
                           </div>
                           <div>
                                <h4 class="font-medium text-slate-600">扩展模块 (SM/CM):</h4>
                               <div id="modules-result" class="p-2 bg-slate-100 rounded-md min-h-[100px]">-</div>
                           </div>
                        </div>
                    </div>
                    <div>
                        <h3 class="font-semibold text-lg mb-3 text-slate-700">配置校验</h3>
                        <div class="space-y-4">
                            <div>
                                <h4 class="font-medium text-slate-600 mb-2">扩展槽位占用:</h4>
                                <div id="slots-result" class="p-2 bg-slate-100 rounded-md">
                                    <p class="text-sm text-slate-500">等待输入...</p>
                                </div>
                            </div>
                            <div>
                                <h4 class="font-medium text-slate-600 mb-2">5V DC 功率预算:</h4>
                                <div class="p-2 bg-slate-100 rounded-md">
                                    <div class="chart-container">
                                        <canvas id="power-chart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

             <!-- Step 3: Bill of Materials -->
            <section id="step3" class="step-card bg-white p-6 rounded-xl shadow-lg border border-slate-200">
                <div class="flex items-center mb-4">
                    <div class="flex-shrink-0 bg-blue-600 text-white rounded-full h-10 w-10 flex items-center justify-center text-xl font-bold">3</div>
                    <h2 class="ml-4 text-2xl font-semibold text-slate-900">物料清单 (BOM)</h2>
                </div>
                <p class="text-slate-600 mb-6">这是根据您的需求生成的完整硬件列表。您可以复制此列表用于采购或存档。</p>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-slate-200">
                        <thead class="bg-slate-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">组件类型</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">型号描述</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">订货号</th>
                                <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider">数量</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">单价 (RMB)</th>
                                <th scope="col" class="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">总价 (RMB)</th>
                            </tr>
                        </thead>
                        <tbody id="bom-table" class="bg-white divide-y divide-slate-200">
                            <tr><td colspan="6" class="p-4 text-center text-slate-500">等待配置生成...</td></tr>
                        </tbody>
                        <tfoot id="bom-footer" class="bg-slate-50 font-bold">
                            <!-- Total cost will be injected here -->
                        </tfoot>
                    </table>
                </div>
            </section>
        </main>
    </div>

<script>
// Data for S7-1200 components, with prices in RMB updated from the user's latest images.
const S7_1200_DATA = {
    cpus: [
        { id: '1211C', name: 'CPU 1211C DC/DC/DC', order: '6ES7211-1AE40-0XB0', di: 6, do_t: 4, do_r: 0, ai: 2, ao: 0, sm: 0, cm: 3, sb: 1, hsc: 6, pto: 4, hsc_freq: 100, pto_freq: 100, power: 750, memory: 75, f_cpu: false, price: 1040 },
        { id: '1212C', name: 'CPU 1212C DC/DC/DC', order: '6ES7212-1AE40-0XB0', di: 8, do_t: 6, do_r: 0, ai: 2, ao: 0, sm: 2, cm: 3, sb: 1, hsc: 6, pto: 4, hsc_freq: 100, pto_freq: 100, power: 1000, memory: 100, f_cpu: false, price: 1403 },
        { id: '1212FC', name: 'CPU 1212FC DC/DC/DC', order: '6ES7212-1AF40-0XB0', di: 8, do_t: 6, do_r: 0, ai: 2, ao: 0, sm: 2, cm: 3, sb: 1, hsc: 6, pto: 4, hsc_freq: 100, pto_freq: 100, power: 1000, memory: 150, f_cpu: true, price: 2900 }, // Price not in latest images, kept old value
        { id: '1214C', name: 'CPU 1214C DC/DC/DC', order: '6ES7214-1AG40-0XB0', di: 14, do_t: 10, do_r: 0, ai: 2, ao: 0, sm: 8, cm: 3, sb: 1, hsc: 6, pto: 4, hsc_freq: 100, pto_freq: 100, power: 1600, memory: 150, f_cpu: false, price: 2123 },
        { id: '1214FC', name: 'CPU 1214FC DC/DC/DC', order: '6ES7214-1AF40-0XB0', di: 14, do_t: 10, do_r: 0, ai: 2, ao: 0, sm: 8, cm: 3, sb: 1, hsc: 6, pto: 4, hsc_freq: 100, pto_freq: 100, power: 1600, memory: 200, f_cpu: true, price: 4100 }, // Price not in latest images, kept old value
        { id: '1215C', name: 'CPU 1215C DC/DC/DC', order: '6ES7215-1AG40-0XB0', di: 14, do_t: 10, do_r: 0, ai: 2, ao: 2, sm: 8, cm: 3, sb: 1, hsc: 6, pto: 4, hsc_freq: 1000, pto_freq: 1000, power: 1600, memory: 200, f_cpu: false, price: 3200 },
        { id: '1215FC', name: 'CPU 1215FC DC/DC/DC', order: '6ES7215-1AF40-0XB0', di: 14, do_t: 10, do_r: 0, ai: 2, ao: 2, sm: 8, cm: 3, sb: 1, hsc: 6, pto: 4, hsc_freq: 1000, pto_freq: 1000, power: 1600, memory: 250, f_cpu: true, price: 5400 }, // Price not in latest images, kept old value
        { id: '1217C', name: 'CPU 1217C DC/DC/DC', order: '6ES7217-1AG40-0XB0', di: 14, do_t: 10, do_r: 0, ai: 2, ao: 2, sm: 8, cm: 3, sb: 1, hsc: 6, pto: 4, hsc_freq: 1000, pto_freq: 1000, power: 1600, memory: 250, f_cpu: false, price: 4626 },
    ],
    modules: [
        { type: 'di', points: 8, name: 'SM 1221, DI 8x24VDC', order: '6ES7221-1BF32-0XB0', power: 105, f_module: false, price: 611 },
        { type: 'di', points: 16, name: 'SM 1221, DI 16x24VDC', order: '6ES7221-1BH32-0XB0', power: 130, f_module: false, price: 976 },
        { type: 'do_t', points: 8, name: 'SM 1222, DQ 8x24VDC', order: '6ES7222-1BF32-0XB0', power: 120, f_module: false, price: 611 },
        { type: 'do_t', points: 16, name: 'SM 1222, DQ 16x24VDC', order: '6ES7222-1BH32-0XB0', power: 150, f_module: false, price: 976 },
        { type: 'do_r', points: 8, name: 'SM 1222, DQ 8xRelay', order: '6ES7222-1HF32-0XB0', power: 120, f_module: false, price: 611 },
        { type: 'do_r', points: 16, name: 'SM 1222, DQ 16xRelay', order: '6ES7222-1HH32-0XB0', power: 190, f_module: false, price: 976 },
        { type: 'dido_t', di: 8, do_t: 8, name: 'SM 1223, DI 8/DQ 8x24VDC', order: '6ES7223-1BH32-0XB0', power: 155, f_module: false, price: 976 },
        { type: 'dido_t', di: 16, do_t: 16, name: 'SM 1223, DI 16/DQ 16x24VDC', order: '6ES7223-1BL32-0XB0', power: 180, f_module: false, price: 1545 },
        { type: 'dido_r', di: 8, do_r: 8, name: 'SM 1223, DI 8/DQ 8xRelay', order: '6ES7223-1PH32-0XB0', power: 185, f_module: false, price: 976 },
        { type: 'dido_r', di: 16, do_r: 16, name: 'SM 1223, DI 16/DQ 16xRelay', order: '6ES7223-1PL32-0XB0', power: 200, f_module: false, price: 1545 },
        { type: 'ai', points: 4, name: 'SM 1231, AI 4x13bit', order: '6ES7231-4HD32-0XB0', power: 80, f_module: false, price: 1260 },
        { type: 'ai', points: 8, name: 'SM 1231, AI 8x13bit', order: '6ES7231-4HF32-0XB0', power: 85, f_module: false, price: 2052 },
        { type: 'ao', points: 2, name: 'SM 1232, AQ 2x14bit', order: '6ES7232-4HB32-0XB0', power: 110, f_module: false, price: 1336 },
        { type: 'ao', points: 4, name: 'SM 1232, AQ 4x14bit', order: '6ES7232-4HD32-0XB0', power: 155, f_module: false, price: 2123 },
        { type: 'aiao', ai: 4, ao: 2, name: 'SM 1234, AI 4/AQ 2', order: '6ES7234-4HE32-0XB0', power: 130, f_module: false, price: 1836 },
        { type: 'tc', points: 4, name: 'SM 1231, AI 4xTC', order: '6ES7231-5QD32-0XB0', power: 80, f_module: false, price: 1761 },
        { type: 'tc', points: 8, name: 'SM 1231, AI 8xTC', order: '6ES7231-5QF32-0XB0', power: 85, f_module: false, price: 2542 },
        { type: 'rtd', points: 4, name: 'SM 1231, AI 4xRTD', order: '6ES7231-5PD32-0XB0', power: 80, f_module: false, price: 1761 },
        { type: 'rtd', points: 8, name: 'SM 1231, AI 8xRTD', order: '6ES7231-5PF32-0XB0', power: 85, f_module: false, price: 2836 },
        { type: 'fdi', points: 16, name: 'F-SM 1226, F-DI 16x24VDC', order: '6ES7226-6BA32-0XB0', power: 100, f_module: true, price: 2100 }, // Price not in latest images, kept old value
        { type: 'fdo', points: 4, name: 'F-SM 1226, F-DQ 4x24VDC', order: '6ES7226-6DA32-0XB0', power: 160, f_module: true, price: 2400 }, // Price not in latest images, kept old value
        { type: 'cm_rs485', points: 1, name: 'CM 1241, RS422/485', order: '6ES7241-1CH32-0XB0', power: 220, is_cm: true, price: 498 },
        { type: 'cm_profibus', points: 1, name: 'CM 1243-5, PROFIBUS DP Master', order: '6GK7243-5DX30-0XE0', power: 200, is_cm: true, price: 2900 }, // Price not in latest images, kept old value
    ]
};

let powerChart;

document.addEventListener('DOMContentLoaded', () => {
    // Attach event listener to the form to trigger updates on any input change.
    const form = document.getElementById('config-form');
    form.addEventListener('input', updateConfiguration);

    // Initialize the power budget chart using Chart.js.
    const ctx = document.getElementById('power-chart').getContext('2d');
    powerChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['功率预算 (mA)'],
            datasets: [
                {
                    label: 'CPU 供电能力',
                    data: [0],
                    backgroundColor: 'rgba(59, 130, 246, 0.5)',
                    borderColor: 'rgba(59, 130, 246, 1)',
                    borderWidth: 1
                },
                {
                    label: '模块总消耗',
                    data: [0],
                    backgroundColor: 'rgba(239, 68, 68, 0.5)',
                    borderColor: 'rgba(239, 68, 68, 1)',
                    borderWidth: 1
                }
            ]
        },
        options: {
            maintainAspectRatio: false,
            responsive: true,
            indexAxis: 'y',
            scales: {
                x: {
                    beginAtZero: true,
                    title: { display: true, text: 'mA' }
                }
            },
            plugins: {
                legend: { position: 'top' },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) { label += ': '; }
                            if (context.parsed.x !== null) { label += context.parsed.x + ' mA'; }
                            return label;
                        }
                    }
                }
            }
        }
    });

    // Run the configuration on initial page load.
    updateConfiguration();
});

// Gathers all user-defined requirements from the form.
function getInputs() {
    const reserve = 1 + (parseInt(document.getElementById('expansion_reserve').value) / 100);
    const do_total = parseInt(document.getElementById('do').value) || 0;
    const do_relay = parseInt(document.getElementById('do_relay').value) || 0;
    
    // Ensure relay DOs don't exceed total DOs.
    if (do_relay > do_total) {
        document.getElementById('do_relay').value = do_total;
        return getInputs(); // Recalculate with corrected value.
    }

    return {
        di: Math.ceil((parseInt(document.getElementById('di').value) || 0) * reserve),
        do: Math.ceil(do_total * reserve),
        do_relay: Math.ceil(do_relay * reserve),
        do_t: Math.ceil((do_total - do_relay) * reserve),
        ai: Math.ceil((parseInt(document.getElementById('ai').value) || 0) * reserve),
        ao: Math.ceil((parseInt(document.getElementById('ao').value) || 0) * reserve),
        tc: Math.ceil((parseInt(document.getElementById('tc').value) || 0) * reserve),
        rtd: Math.ceil((parseInt(document.getElementById('rtd').value) || 0) * reserve),
        hsc: parseInt(document.getElementById('hsc').value) || 0,
        pto: parseInt(document.getElementById('pto').value) || 0,
        comm_rs485: document.getElementById('comm_rs485').checked,
        comm_profibus: document.getElementById('comm_profibus').checked,
        fail_safe: document.getElementById('fail_safe').checked,
    };
}

// Main function to calculate and update the configuration based on inputs.
function updateConfiguration() {
    const needs = getInputs();
    let errorMessages = [];
    
    // Filter CPUs that meet basic functional requirements (HSC, PTO, Fail-Safe).
    const potentialCpus = S7_1200_DATA.cpus.filter(cpu => 
        cpu.hsc >= needs.hsc && 
        cpu.pto >= needs.pto &&
        cpu.f_cpu === needs.fail_safe
    );

    if (potentialCpus.length === 0) {
        errorMessages.push(`找不到满足基本功能需求的CPU (HSC/PTO/Fail-Safe).`);
        renderResults(null, [], 0, errorMessages);
        return;
    }

    let bestConfig = null;

    // Iterate through each potential CPU to find the most cost-effective valid configuration.
    for (const cpu of potentialCpus) {
        let currentModules = [];
        let remaining = { ...needs };
        let tempError = [];

        // Subtract I/O points provided by the CPU itself.
        remaining.di -= cpu.di;
        remaining.do_t -= cpu.do_t;
        remaining.do_r -= cpu.do_r;
        remaining.ai -= cpu.ai;
        remaining.ao -= cpu.ao;

        // Add required communication modules.
        let needed_cm = 0;
        if(needs.comm_rs485) {
            currentModules.push(S7_1200_DATA.modules.find(m => m.type === 'cm_rs485'));
            needed_cm++;
        }
        if(needs.comm_profibus) {
            currentModules.push(S7_1200_DATA.modules.find(m => m.type === 'cm_profibus'));
            needed_cm++;
        }
        
        // Check if CPU supports the required number of communication modules.
        if (needed_cm > cpu.cm) {
            tempError.push(`${cpu.name} 不支持 ${needed_cm} 个通信模块。`);
            continue; // Try next CPU.
        }
        
        // Helper function to add a specific type of module to fulfill a need.
        const addModule = (type, prop) => {
            let modulesOfType = S7_1200_DATA.modules
                .filter(m => m.type === type && (m.f_module ? needs.fail_safe : !needs.fail_safe)) // Match f-safe status
                .sort((a, b) => (a.price / a.points) - (b.price / b.points)); // Prioritize cost-effectiveness
            
            while (remaining[prop] > 0 && modulesOfType.length > 0) {
                let module = modulesOfType[0]; // Choose cheapest per point
                currentModules.push(module);
                remaining[prop] -= module.points;
            }
        };

        // Heuristic to add mixed I/O modules first if they are cost-effective.
        const addMixedModule = (type, prop_di, prop_do) => {
             let modulesOfType = S7_1200_DATA.modules.filter(m => m.type === type);
             if(remaining[prop_di] > 4 && remaining[prop_do] > 4 && modulesOfType.length > 0){
                 let module = modulesOfType[0];
                 currentModules.push(module);
                 remaining[prop_di] -= module.di;
                 remaining[prop_do] -= module[Object.keys(module).find(k => k.startsWith('do_'))];
             }
        }
        
        // Logic to select modules based on remaining needs.
        if (needs.fail_safe) {
            addModule('fdi', 'di');
            addModule('fdo', 'do_t');
        } else {
            addMixedModule('dido_t', 'di', 'do_t');
            addMixedModule('dido_r', 'di', 'do_r');
            addModule('di', 'di');
            addModule('do_t', 'do_t');
            addModule('do_r', 'do_r');
            addMixedModule('aiao', 'ai', 'ao');
            addModule('ai', 'ai');
            addModule('ao', 'ao');
            addModule('tc', 'tc');
            addModule('rtd', 'rtd');
        }
        
        // Validate slot and power constraints.
        let sm_count = currentModules.filter(m => !m.is_cm).length;
        if (sm_count > cpu.sm) {
            tempError.push(`${cpu.name} 无法支持 ${sm_count} 个信号模块 (最多 ${cpu.sm} 个).`);
            continue;
        }

        const totalPower = currentModules.reduce((sum, m) => sum + m.power, 0);
        if (totalPower > cpu.power) {
            tempError.push(`${cpu.name} 功率预算不足 (需要: ${totalPower}mA, 提供: ${cpu.power}mA).`);
            continue;
        }

        // If this configuration is valid, check if it's the best one found so far (cheapest).
        const currentCost = cpu.price + currentModules.reduce((sum, m) => sum + m.price, 0);
        if (!bestConfig || currentCost < bestConfig.cost) {
            bestConfig = { cpu: cpu, modules: currentModules, cost: currentCost, errors: [] };
        }
    }
    
    // Render the final results.
    if (bestConfig) {
        renderResults(bestConfig.cpu, bestConfig.modules, bestConfig.cost, bestConfig.errors);
    } else {
         errorMessages.push(`无法为您的需求找到一个有效的配置。请尝试调整需求或选择更高阶的CPU系列。`);
        renderResults(null, [], 0, errorMessages);
    }
}

// Renders the calculated configuration to the UI.
function renderResults(cpu, modules, totalCost, errors) {
    const validationSummaryEl = document.getElementById('validation-summary');
    const cpuResultEl = document.getElementById('cpu-result');
    const modulesResultEl = document.getElementById('modules-result');
    const slotsResultEl = document.getElementById('slots-result');
    const bomTableEl = document.getElementById('bom-table');
    const bomFooterEl = document.getElementById('bom-footer');

    // Clear previous results
    validationSummaryEl.innerHTML = '';
    bomTableEl.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-slate-500">等待配置生成...</td></tr>';
    bomFooterEl.innerHTML = '';

    if (errors.length > 0) {
        validationSummaryEl.className = 'error-message p-4 rounded-lg';
        validationSummaryEl.innerHTML = `<strong>配置错误:</strong><ul class="list-disc list-inside mt-2">${errors.map(e => `<li>${e}</li>`).join('')}</ul>`;
    }

    if (!cpu) {
        cpuResultEl.innerHTML = '-';
        modulesResultEl.innerHTML = '-';
        slotsResultEl.innerHTML = '<p class="text-sm text-slate-500">等待输入...</p>';
        powerChart.data.datasets[0].data[0] = 0;
        powerChart.data.datasets[1].data[0] = 0;
        powerChart.options.scales.x.max = 100;
        powerChart.update();
        return;
    }
    
    const totalPower = modules.reduce((sum, m) => sum + m.power, 0);
    const sm_count = modules.filter(m => !m.is_cm).length;
    const cm_count = modules.filter(m => m.is_cm).length;

    // Validation Summary
    if (errors.length === 0) {
        validationSummaryEl.className = 'success-message p-4 rounded-lg';
        validationSummaryEl.innerHTML = '<strong>配置校验通过!</strong> 这是一个基于您需求的有效硬件组合。';
    }

    // Recommended Hardware
    cpuResultEl.innerHTML = `<span class="font-bold result-highlight">${cpu.name}</span> <br> <span class="text-sm text-slate-500">${cpu.order}</span>`;
    
    const moduleCounts = modules.reduce((acc, m) => {
        acc[m.order] = (acc[m.order] || { ...m, count: 0 });
        acc[m.order].count++;
        return acc;
    }, {});

    if (Object.keys(moduleCounts).length > 0) {
        modulesResultEl.innerHTML = Object.values(moduleCounts).map(m => `<div class="text-sm">${m.count}x ${m.name} (${m.order})</div>`).join('');
    } else {
        modulesResultEl.innerHTML = '<span class="text-sm text-slate-500">无需额外模块。</span>';
    }
    
    // Validation Details: Slots
    let slotsHtml = `<div class="flex items-center space-x-2 flex-wrap">`;
    slotsHtml += `<div class="p-2 bg-blue-200 text-blue-800 rounded text-xs font-mono">CPU</div>`;
    for(let i=0; i < sm_count; i++) slotsHtml += `<div class="p-2 bg-green-200 text-green-800 rounded text-xs font-mono">SM</div>`;
    for(let i=0; i < cpu.sm - sm_count; i++) slotsHtml += `<div class="p-2 bg-slate-200 text-slate-500 rounded text-xs font-mono">空闲</div>`;
    slotsHtml += `</div><p class="text-xs text-slate-500 mt-2">已用信号模块槽位: ${sm_count} / ${cpu.sm}</p>`;
    slotsHtml += `<p class="text-xs text-slate-500 mt-1">已用通信模块槽位: ${cm_count} / ${cpu.cm}</p>`;
    slotsResultEl.innerHTML = slotsHtml;

    // Validation Details: Power Chart Update
    powerChart.data.datasets[0].data[0] = cpu.power;
    powerChart.data.datasets[1].data[0] = totalPower;
    powerChart.options.scales.x.max = Math.max(cpu.power, totalPower, 100) * 1.2;
    powerChart.update();
    
    // BOM Table
    let bomHtml = '';
    // CPU Row
    bomHtml += `<tr>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-700">CPU</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-700">${cpu.name}</td>
        <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-slate-500">${cpu.order}</td>
        <td class="px-6 py-4 text-center text-sm text-slate-700">1</td>
        <td class="px-6 py-4 text-right text-sm font-mono text-slate-700">${cpu.price.toFixed(2)}</td>
        <td class="px-6 py-4 text-right text-sm font-mono text-slate-700 font-semibold">${cpu.price.toFixed(2)}</td>
    </tr>`;
    
    // Module Rows
    Object.values(moduleCounts).forEach(m => {
        let type = '信号模块 (SM)';
        if (m.is_cm) type = '通信模块 (CM)';
        if (m.f_module) type = '故障安全模块 (F-SM)';
        const itemTotal = m.price * m.count;
        bomHtml += `<tr>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-700">${type}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-700">${m.name}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-slate-500">${m.order}</td>
            <td class="px-6 py-4 text-center text-sm text-slate-700">${m.count}</td>
            <td class="px-6 py-4 text-right text-sm font-mono text-slate-700">${m.price.toFixed(2)}</td>
            <td class="px-6 py-4 text-right text-sm font-mono text-slate-700 font-semibold">${itemTotal.toFixed(2)}</td>
        </tr>`;
    });
    bomTableEl.innerHTML = bomHtml;

    // BOM Footer with Total Cost
    bomFooterEl.innerHTML = `
        <tr>
            <td colspan="5" class="px-6 py-4 text-right text-base font-bold text-slate-700 uppercase">总计成本</td>
            <td class="px-6 py-4 text-right text-base font-mono text-slate-900">${totalCost.toFixed(2)}</td>
        </tr>`;
}
</script>

</body>
</html>
