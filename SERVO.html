<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>伺服驱动器交互式对比工具 (AI增强版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chosen Palette: Professional Tech Neutral -->
    <!-- Application Structure Plan: The application is designed as a single-page interactive comparison tool. The information architecture prioritizes user task-flow over the original report's linear structure. Key components are: 1. An introduction section to set context. 2. A core interactive module with two dropdowns for selecting servos to compare. This is the primary user interaction point. 3. A dynamic comparison display area that updates instantly based on selections. This area includes: a) A visual bar chart for key performance metrics (bandwidth, resolution) for quick quantitative comparison. b) A side-by-side detailed specification table for factual data. c) Side-by-side qualitative analysis cards (Advantages, Disadvantages, Expert Analysis) for deeper insights. d) [NEW] An AI-powered summary section generated by the Gemini API, which provides a narrative comparison and scenario-based recommendations. This structure was chosen because the primary goal for an expert user is direct, multi-faceted comparison to aid in decision-making. The AI feature adds a layer of intelligent synthesis on top of the raw data, making the tool more powerful. -->
    <!-- Visualization & Content Choices: 
        - Report Info: Servo series technical specifications and expert analysis. -> Goal: Direct Comparison. -> Viz/Presentation: Two dropdowns for selection, a Chart.js bar chart, and side-by-side HTML tables/cards. -> Interaction: Dropdown `onchange` events trigger a full update of the comparison section. -> Justification: This multi-format presentation caters to different analysis needs. -> Library/Method: Chart.js, Vanilla JS.
        - [NEW] Report Info: Data for two selected servos. -> Goal: Generate an expert-level comparative analysis. -> Viz/Presentation: A button to trigger the analysis and a dedicated card to display the formatted text response. Includes loading and error states. -> Interaction: User clicks a button. The app sends a structured prompt with the servo data to the Gemini API and displays the streaming response. -> Justification: This leverages LLMs to synthesize complex technical data into actionable insights, providing value beyond simple data presentation. -> Library/Method: Gemini API via `fetch`, Vanilla JS.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', 'Helvetica Neue', 'Hiragino Sans GB', 'WenQuanYi Micro Hei', 'Microsoft Yahei', sans-serif;
            background-color: #f8fafc; /* slate-50 */
            color: #1e293b; /* slate-800 */
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 400px;
            }
        }
        .custom-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        .gemini-report h3 {
            font-size: 1.125rem; /* text-lg */
            font-weight: 600; /* font-semibold */
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            padding-bottom: 0.25rem;
            border-bottom: 1px solid #e2e8f0; /* border-slate-200 */
        }
        .gemini-report ul {
            list-style-type: disc;
            padding-left: 1.5rem;
            margin-bottom: 1rem;
        }
         .gemini-report li {
            margin-bottom: 0.25rem;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="antialiased">

    <div class="container mx-auto p-4 md:p-8">
        
        <header class="text-center mb-8 md:mb-12">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900 mb-2">伺服驱动器交互式对比工具 (AI增强版)</h1>
            <p class="text-slate-600 max-w-3xl mx-auto">
                本工具基于专家级分析报告，旨在帮助自动化专业人士快速、直观地对比不同伺服驱动器系列。现已集成Gemini AI，可为您生成深度对比报告和选型建议。
            </p>
        </header>

        <main>
            <div class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200 sticky top-4 z-10">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 items-end">
                    <div>
                        <label for="servo1" class="block text-sm font-medium text-slate-700 mb-1">选择对比系列 1</label>
                        <select id="servo1" class="custom-select w-full p-3 bg-slate-50 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                            <option value="">-- 请选择 --</option>
                        </select>
                    </div>
                    <div>
                        <label for="servo2" class="block text-sm font-medium text-slate-700 mb-1">选择对比系列 2</label>
                        <select id="servo2" class="custom-select w-full p-3 bg-slate-50 border border-slate-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                            <option value="">-- 请选择 --</option>
                        </select>
                    </div>
                </div>
            </div>

            <div id="comparison-results" class="mt-8">
                <div id="initial-state" class="text-center py-16 px-6 bg-white rounded-2xl shadow-lg border border-slate-200">
                    <svg class="mx-auto h-12 w-12 text-slate-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m5.231 13.481L15 17.25m-4.5 0-2.269-2.269a2.625 2.625 0 00-3.712 0l-1.5 1.5a2.625 2.625 0 000 3.712l2.269 2.269a2.625 2.625 0 003.712 0l1.5-1.5a2.625 2.625 0 000-3.712z" />
                    </svg>
                    <h3 class="mt-2 text-xl font-semibold text-slate-900">准备开始对比</h3>
                    <p class="mt-1 text-slate-500">请从上方的两个下拉菜单中选择您感兴趣的伺服系列。</p>
                </div>
            </div>
        </main>
        
        <footer class="text-center mt-12 text-sm text-slate-500">
            <p>&copy; 2025 自动化专家分析工具. AI分析由Google Gemini提供。</p>
        </footer>
    </div>

    <script>
        const servoData = [
             { id: 'siemens_s200', manufacturer: '西门子 (Siemens)', name: 'SINAMICS S200', tagline: 'TIA生态集成标准型伺服', bandwidth: null, resolution: 21, powerRange: '0.1-7kW', protocols: 'PROFINET IRT, 脉冲', safety: 'STO (SIL 3/PLe) (标准版)', pros: ['与TIA Portal生态系统无缝集成', 'PROFINET IRT支持高性能同步运动', '高编码器分辨率 (21位)', '全面的全球支持与认证'], cons: ['速度环带宽未明确说明，难以直接比较', '基础版缺少STO功能', '无高级安全功能 (如SS1, SLS)'], analysis: 'S200是集成到西门子自动化环境中的可靠选择。其优势在于生态系统集成和PROFINET通讯，而非追求极致的原始性能指标。对于已采用西门子PLC的用户，其易用性和集成度是巨大优势。'},
             { id: 'inovance_sv660', manufacturer: '汇川 (Inovance)', name: 'SV660N', tagline: '高性能通用型伺服', bandwidth: 3.0, resolution: 23, powerRange: '0.05-7.5kW', protocols: 'EtherCAT, Modbus, CANopen, CANLink, Profinet', safety: 'STO (SIL 3)', pros: ['极高的速度环带宽 (3.0kHz)', '高编码器分辨率 (23位)', '通讯协议支持广泛，尤其EtherCAT', '自动调谐功能简化调试'], cons: ['无高级安全功能', '软件生态系统可能不如老牌厂商统一'], analysis: 'SV660N在核心性能指标（带宽、编码器）上极具竞争力，结合广泛的通讯支持，使其成为一个强大的多面手，特别适合新建的、优先考虑EtherCAT的系统。'},
             { id: 'inovance_sv670', manufacturer: '汇川 (Inovance)', name: 'SV670P/N', tagline: '坚固型高端伺服', bandwidth: 3.2, resolution: 23, powerRange: '0.05-7.5kW', protocols: 'P型: Modbus, 脉冲; N型: 可能含EtherCAT', safety: 'STO (SIL 3)', pros: ['出色的速度环带宽 (3.2kHz)', '针对恶劣环境的坚固设计 (三防涂层)', '高级调谐功能 (ITune)', '全闭环能力和USB-C无电源调试'], cons: ['N型EtherCAT支持未明确证实', '无高级安全功能'], analysis: 'SV670在SV660的基础上，增强了性能和环境适应性。其坚固的设计和用户友好的调试特性，使其适用于对可靠性要求严苛的高性能应用。'},
             { id: 'inovance_sv680', manufacturer: '汇川 (Inovance)', name: 'SV680P/N', tagline: '旗舰级性能与安全', bandwidth: 3.5, resolution: 26, powerRange: '>=7.5kW (预计)', protocols: 'EtherCAT (含FSoE), 脉冲 (8Mpps)', safety: 'STO, SS1, SS2, SLS, SBC, SOS, SSM, SDI (均为SIL 3 PLe), FSoE', pros: ['顶级的速度环带宽 (3.5kHz) 和编码器分辨率 (26位)', '最全面的集成安全功能，包括FSoE', '高级诊断功能 (黑匣子)', '专为半导体等苛刻应用设计 (SEMI F47)'], cons: ['价格可能较高', '功能复杂，学习曲线可能较陡'], analysis: 'SV680是汇川的旗舰产品，明确对标国际顶级伺服。其在性能、精度和功能安全上的全面领先，使其成为复杂、高要求、安全关键型应用的理想选择。'},
             { id: 'delta_a2', manufacturer: '台达 (Delta)', name: 'ASDA-A2', tagline: '功能全面的中高端伺服', bandwidth: 1.0, resolution: 20, powerRange: '0.1-15kW', protocols: 'CANopen, Modbus, 脉冲, DMCNET, EtherCAT (E型)', safety: 'STO (SIL2/PLd) (仅E型)', pros: ['性能均衡，适用范围广', '强大的内置运动功能 (Pr模式, E-CAM)', '型号多样，满足不同通讯需求', '通常被认为性价比高'], cons: ['带宽 (1kHz) 低于最新一代产品', 'STO功能主要限于EtherCAT型号'], analysis: 'ASDA-A2是台达的经典主力，以其丰富的功能集和良好的性价比著称。尤其其内置的E-CAM功能，在某些应用中可以简化上位机编程，是其一大亮点。'},
             { id: 'delta_b2', manufacturer: '台达 (Delta)', name: 'ASDA-B2', tagline: '高性价比通用型伺服', bandwidth: 0.55, resolution: 17, powerRange: '0.1-3kW', protocols: 'Modbus, 脉冲', safety: '未明确', pros: ['通用型应用的高性价比之选', '满足基本的位置、速度、转矩控制', '易于安装和调试'], cons: ['性能指标 (带宽、分辨率) 较低', '通讯选项有限', '无安全功能'], analysis: 'ASDA-B2定位于入门级市场，是步进电机升级或简单伺服应用的理想选择。它不追求高性能，而是专注于在成本效益和可靠性之间取得平衡。'},
             { id: 'delta_b3', manufacturer: '台达 (Delta)', name: 'ASDA-B3', tagline: '新一代高性能标准伺服', bandwidth: 3.1, resolution: 24, powerRange: '0.1-3kW (示例)', protocols: '脉冲, RS-485 (未来支持CANopen, EtherCAT)', safety: 'STO (SIL2)', pros: ['卓越的性能 (3.1kHz带宽, 24位编码器)', '内置STO安全功能', '紧凑设计，节省安装空间', '高级自动调谐和振动抑制'], cons: ['高级通讯总线 (EtherCAT) 仍在推广中', '无STO之外的高级安全功能'], analysis: 'ASDA-B3是台达的一次重大飞跃，将标准伺服的性能提升到了高端水平。其强大的性能指标和内置STO，使其在各类新设计中都极具竞争力。'},
             { id: 'mitsubishi_je', manufacturer: '三菱 (Mitsubishi)', name: 'MELSERVO-JE', tagline: '可靠的通用型伺服', bandwidth: 2.0, resolution: 17, powerRange: '最高3kW', protocols: '脉冲, 模拟, Modbus, SSCNET III/H, CC-Link IE Field Basic', safety: 'STO (部分型号)', pros: ['性能良好 (2.0kHz带宽)', '多种接口，与三菱生态系统无缝集成', '成熟可靠，市场保有量大', '有效的自动调谐功能'], cons: ['编码器分辨率 (17位) 较低', '无高级安全功能'], analysis: 'MELSERVO-JE是一款可靠的主力产品。它的核心优势在于与三菱PLC生态系统的深度整合和多样的专有网络支持，为三菱用户提供了灵活且可靠的选择。'},
             { id: 'mitsubishi_j4', manufacturer: '三菱 (Mitsubishi)', name: 'MELSERVO-J4', tagline: '高性能多功能伺服', bandwidth: 2.5, resolution: 22, powerRange: '0.1-55kW', protocols: '脉冲, Modbus, SSCNET III/H, CC-Link IE Field, EtherCAT, PROFINET, EIP (TM型)', safety: 'STO, SS1', pros: ['高性能 (2.5kHz带宽, 22位编码器)', '宽功率范围，兼容旋转、直线和DD电机', '通讯选项极为广泛 (TM型号)', '标配STO和SS1安全功能'], cons: ['高级安全功能不如汇川SV680广泛', 'TM型号价格可能较高'], analysis: 'MELSERVO-J4是一款强大的高性能伺服，适用于要求苛刻的应用。其最大的优势在于全面的电机支持和TM型号提供的广泛通讯协议，使其能轻松集成到任何主流控制系统中。'}
        ];

        const servo1Select = document.getElementById('servo1');
        const servo2Select = document.getElementById('servo2');
        const comparisonResultsDiv = document.getElementById('comparison-results');
        const initialStateDiv = document.getElementById('initial-state');
        let chart = null;

        function populateSelects() {
            const manufacturers = [...new Set(servoData.map(s => s.manufacturer))];
            manufacturers.forEach(m => {
                const optgroup1 = document.createElement('optgroup');
                optgroup1.label = m;
                const optgroup2 = document.createElement('optgroup');
                optgroup2.label = m;
                const servosByManufacturer = servoData.filter(s => s.manufacturer === m);
                servosByManufacturer.forEach(s => {
                    const option1 = new Option(`${s.name} (${s.manufacturer.split(' ')[0]})`, s.id);
                    optgroup1.appendChild(option1);
                    const option2 = new Option(`${s.name} (${s.manufacturer.split(' ')[0]})`, s.id);
                    optgroup2.appendChild(option2);
                });
                servo1Select.appendChild(optgroup1);
                servo2Select.appendChild(optgroup2);
            });
        }
        
        function updateSelectOptions() {
            const val1 = servo1Select.value;
            const val2 = servo2Select.value;
            for (let option of servo1Select.options) { option.disabled = (option.value === val2 && val2 !== ""); }
            for (let option of servo2Select.options) { option.disabled = (option.value === val1 && val1 !== ""); }
        }

        function createComparisonCard(servo) {
            return `<div class="bg-white p-6 rounded-xl border border-slate-200 h-full flex flex-col">
                <h3 class="text-xl md:text-2xl font-bold text-slate-900">${servo.name}</h3>
                <p class="text-sm text-slate-500 mb-1">${servo.manufacturer}</p>
                <p class="text-sm font-semibold text-blue-600 bg-blue-100 px-3 py-1 rounded-full self-start mb-4">${servo.tagline}</p>
                <div class="space-y-4 flex-grow">
                    <div><h4 class="font-semibold text-slate-800 border-b border-slate-200 pb-1 mb-2">优势</h4><ul class="list-disc list-inside space-y-1 text-slate-600 text-sm">${servo.pros.map(pro => `<li>${pro}</li>`).join('')}</ul></div>
                    <div><h4 class="font-semibold text-slate-800 border-b border-slate-200 pb-1 mb-2">劣势/局限性</h4><ul class="list-disc list-inside space-y-1 text-slate-600 text-sm">${servo.cons.map(con => `<li>${con}</li>`).join('')}</ul></div>
                    <div><h4 class="font-semibold text-slate-800 border-b border-slate-200 pb-1 mb-2">专家解读</h4><p class="text-slate-600 text-sm">${servo.analysis}</p></div>
                </div></div>`;
        }

        function createComparisonTable(servo1, servo2) {
            const fields = [
                { label: '制造商', key: 'manufacturer' }, { label: '功率范围', key: 'powerRange' }, { label: '速度环带宽 (kHz)', key: 'bandwidth' },
                { label: '编码器分辨率 (位)', key: 'resolution' }, { label: '主要通讯协议', key: 'protocols' }, { label: '功能安全', key: 'safety' }
            ];
            function formatValue(value) {
                if (value === null) return '<span class="text-slate-500 italic">未明确说明</span>';
                if (typeof value === 'number') return `<strong>${value}</strong>`;
                return value;
            }
            let tableHTML = '<div class="overflow-x-auto"><table class="w-full text-sm text-left text-slate-500">';
            tableHTML += '<thead class="text-xs text-slate-700 uppercase bg-slate-100">';
            tableHTML += `<tr><th scope="col" class="px-6 py-3 rounded-l-lg">特性</th><th scope="col" class="px-6 py-3">${servo1.name}</th><th scope="col" class="px-6 py-3 rounded-r-lg">${servo2.name}</th></tr></thead><tbody>`;
            fields.forEach((field) => {
                tableHTML += `<tr class="bg-white border-b"><th scope="row" class="px-6 py-4 font-medium text-slate-900 whitespace-nowrap">${field.label}</th><td class="px-6 py-4">${formatValue(servo1[field.key])}</td><td class="px-6 py-4">${formatValue(servo2[field.key])}</td></tr>`;
            });
            tableHTML += '</tbody></table></div>';
            return tableHTML;
        }

        function updateComparison() {
            updateSelectOptions();
            const servo1Id = servo1Select.value;
            const servo2Id = servo2Select.value;

            if (!servo1Id || !servo2Id) {
                comparisonResultsDiv.innerHTML = '';
                comparisonResultsDiv.appendChild(initialStateDiv);
                return;
            }
            
            initialStateDiv.remove();

            const s1 = servoData.find(s => s.id === servo1Id);
            const s2 = servoData.find(s => s.id === servo2Id);

            const content = `
                <div class="space-y-8">
                    <section class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200">
                        <h2 class="text-2xl font-bold text-slate-900 text-center mb-6">核心性能指标对比</h2>
                        <div class="chart-container"><canvas id="performanceChart"></canvas></div>
                        <p class="text-xs text-center text-slate-400 mt-4">* 西门子S200的速度环带宽未在官方资料中明确，图表以0表示，仅供参考。</p>
                    </section>
                    
                    <section id="ai-section" class="bg-gradient-to-br from-blue-50 to-indigo-100 p-6 rounded-2xl shadow-lg border border-blue-200">
                        <h2 class="text-2xl font-bold text-slate-900 text-center mb-4">✨ AI智能对比分析</h2>
                        <div class="flex justify-center">
                            <button id="generate-ai-report" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition-all shadow-md hover:shadow-lg transform hover:-translate-y-0.5">
                                生成Gemini分析报告
                            </button>
                        </div>
                        <div id="ai-report-container" class="mt-4 hidden"></div>
                    </section>
                    
                    <section class="bg-white p-6 rounded-2xl shadow-lg border border-slate-200">
                        <h2 class="text-2xl font-bold text-slate-900 text-center mb-6">详细规格参数</h2>
                        ${createComparisonTable(s1, s2)}
                    </section>
                    
                    <section>
                        <h2 class="text-2xl font-bold text-slate-900 text-center mb-6">专家分析与解读</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">${createComparisonCard(s1)}${createComparisonCard(s2)}</div>
                    </section>
                </div>`;
            comparisonResultsDiv.innerHTML = content;

            document.getElementById('generate-ai-report').addEventListener('click', handleAiReportGeneration);
            createChart(s1, s2);
        }
        
        async function handleAiReportGeneration() {
            const button = document.getElementById('generate-ai-report');
            const container = document.getElementById('ai-report-container');

            button.disabled = true;
            container.innerHTML = `<div class="flex flex-col items-center justify-center p-4">
                                       <div class="spinner"></div>
                                       <p class="text-slate-600 mt-3">Gemini正在分析数据，请稍候...</p>
                                   </div>`;
            container.classList.remove('hidden');

            const servo1Id = servo1Select.value;
            const servo2Id = servo2Select.value;
            const s1 = servoData.find(s => s.id === servo1Id);
            const s2 = servoData.find(s => s.id === servo2Id);

            const prompt = `你是一位资深的自动化集成专家和技术顾问。请基于以下两款伺服驱动器的详细数据，为一位正在进行技术选型的工程师，撰写一份专业的对比分析报告。

产品1: ${s1.name}
- 制造商: ${s1.manufacturer}
- 核心卖点: ${s1.tagline}
- 速度环带宽: ${s1.bandwidth || '未明确说明'} kHz
- 编码器分辨率: ${s1.resolution} 位
- 通讯协议: ${s1.protocols}
- 功能安全: ${s1.safety}
- 专家解读: ${s1.analysis}

产品2: ${s2.name}
- 制造商: ${s2.manufacturer}
- 核心卖点: ${s2.tagline}
- 速度环带宽: ${s2.bandwidth || '未明确说明'} kHz
- 编码器分辨率: ${s2.resolution} 位
- 通讯协议: ${s2.protocols}
- 功能安全: ${s2.safety}
- 专家解读: ${s2.analysis}

你的报告应包含以下结构清晰的要点:
1.  **开篇总结**: 对两款产品的定位和核心优势进行简要概括。
2.  **性能对决**: 深入比较速度环带宽和编码器分辨率，并解释这些差异对实际应用（如响应速度、定位精度）的影响。
3.  **生态与集成**: 分析它们各自的通讯协议，并评估与主流PLC（如西门子, 汇川, 台达, 三菱）的集成便利性。
4.  **选型建议**: 针对至少两种不同的应用场景（例如：高动态响应的包装机械 vs. 成本敏感的通用传送带），明确推荐更合适的型号，并详细说明理由。

请确保报告语言精炼、专业、客观，并以带有标题和列表的易读格式呈现。`;
            
            try {
                const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API 请求失败，状态码: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                    let text = result.candidates[0].content.parts[0].text;
                    // Basic markdown to HTML
                    text = text.replace(/## (.*)/g, '<h3>$1</h3>')
                               .replace(/\* (.*)/g, '<li>$1</li>')
                               .replace(/(\r\n|\n|\r)/g, '<br>')
                               .replace(/<\/li><br>/g, '</li>');
                    
                    container.innerHTML = `<div class="p-4 bg-white rounded-lg shadow-inner gemini-report text-slate-700 leading-relaxed">${text}</div>`;
                } else {
                    throw new Error("从API返回的响应格式无效或内容为空。");
                }

            } catch (error) {
                console.error("Gemini API Error:", error);
                container.innerHTML = `<div class="p-4 bg-red-100 text-red-800 rounded-lg shadow-inner">
                                        <h4 class="font-bold">分析失败</h4>
                                        <p>无法连接到AI服务或处理请求时出错。请检查您的网络连接并稍后重试。</p>
                                        <p class="text-xs mt-2">错误详情: ${error.message}</p>
                                      </div>`;
            } finally {
                button.disabled = false;
                button.style.display = 'none'; // Hide button after generation
            }
        }

        function createChart(servo1, servo2) {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            if(chart) { chart.destroy(); }
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['速度环带宽 (kHz)', '编码器分辨率 (位)'],
                    datasets: [
                        { label: servo1.name, data: [servo1.bandwidth || 0, servo1.resolution], backgroundColor: 'rgba(59, 130, 246, 0.7)', borderColor: 'rgba(59, 130, 246, 1)', borderWidth: 1, borderRadius: 6 },
                        { label: servo2.name, data: [servo2.bandwidth || 0, servo2.resolution], backgroundColor: 'rgba(107, 114, 128, 0.7)', borderColor: 'rgba(107, 114, 128, 1)', borderWidth: 1, borderRadius: 6 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#e2e8f0' }, ticks: { color: '#475569' } },
                        x: { grid: { display: false }, ticks: { color: '#475569', font: { size: 14 } } }
                    },
                    plugins: {
                        legend: { position: 'top', labels: { color: '#1e293b', font: { size: 14 } } },
                        tooltip: {
                            backgroundColor: '#1e293b', titleFont: { size: 16 }, bodyFont: { size: 14 },
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) { label += ': '; }
                                    if (context.parsed.y !== null) {
                                        if(context.dataset.data[context.dataIndex] === 0 && context.label.includes('带宽')){
                                             label += '未明确说明';
                                        } else { label += context.parsed.y; }
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            populateSelects();
            servo1Select.addEventListener('change', updateComparison);
            servo2Select.addEventListener('change', updateComparison);
        });

    </script>
</body>
</html>
